import 'github-markdown-css'
import { cveFirstThenGhsa, severityColor } from '../../utils/config'
import Link from '../link'
import Markdown  from 'marked-react'
import { packageLink } from '../../utils/config'
import { useState } from 'react'


export default function Vulnerability({ advisory, vuln }) {

   const [showDescription, setShowDescription] = useState(false)

   const identifier = () => [...advisory.identifiers].sort(cveFirstThenGhsa)[0]?.value ?? 'Unknown identifier'
   const toggleDescription = () => setShowDescription(!showDescription)

   return (
      <>
         <tr className='border-b border-b-gray-300 hover:bg-gray-50 cursor-pointer' onClick={toggleDescription}>
            <td className='w-[13%] text-center py-1'>
               <span className={`font-semibold text-xs ${severityColor[vuln.severity].text} border ${severityColor[vuln.severity].border} rounded-xl px-2 py-[1px]`}>
                  {vuln.severity.toLowerCase()}
               </span>
            </td>
            <td className='w-[17%] tabular-nums'>
               <Link href={advisory.permalink}>{identifier()}</Link>
            </td>
            <td className='w-[45%]'>
               <Link href={packageLink(vuln.package.ecosystem, vuln.package.name)}>{vuln.package.name}</Link>
            </td>
            <td className='w-[14%] text-center'>{vuln.vulnerableVersionRange}</td>
            <td className='w-[11%] text-center'>{vuln.firstPatchedVersion?.identifier ?? 'Unknown'}</td>
         </tr>
         {showDescription && (
            <tr>
               <td colSpan={5}>
                  <div className='my-3 p-3 rounded-sm border border-gray-300'>
                     <div className='markdown-body' style={{ fontSize: '14px' }}>
                        <h2>{advisory.summary}</h2>
                        <Markdown>{advisory.description}</Markdown>
                     </div>
                  </div>
               </td>
            </tr>
         )}
      </>
   )
}
